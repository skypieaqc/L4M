@model List<UserViewModel>
@{
    ViewData["Title"] = "Admin Paneli";
}

<div class="admin-container">
    <h2>Kullanıcı Yönetimi</h2>

    <!-- Arama ve Filtreleme -->
    <div class="row mb-3">
        <div class="col-md-6">
            <input type="text" id="searchInput" class="form-control" placeholder="Kullanıcı ara...">
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="thead-dark">
                <tr>
                    <th>ID</th>
                    <th>Tam Ad</th>
                    <th>Email</th>
                    <th>Şifre Hash</th>
                    <th>Rol</th>
                    <th>Durum</th>
                    <th>İşlemler</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in Model)
                {
                    <tr>
                        <td>@user.Id.Substring(0, 8)...</td>
                        <td>@user.FullName</td>
                        <td>@user.Email</td>
                        <td>
                            <small class="text-muted">@user.PasswordHash?.Substring(0, 15)...</small>
                            <button class="btn btn-sm btn-outline-secondary copy-hash" data-hash="@user.PasswordHash">
                                <i class="fas fa-copy"></i>
                            </button>
                        </td>
                        <td>
                            @if (user.IsAdmin)
                            {
                                <span class="badge bg-danger">Admin</span>
                            }
                            else
                            {
                                <span class="badge bg-primary">Kullanıcı</span>
                            }
                        </td>
                        <td>
                            @if (user.LockoutEnd?.UtcDateTime > DateTime.UtcNow)
                            {
                                <span class="badge bg-warning">Kilitli</span>
                            }
                            else
                            {
                                <span class="badge bg-success">Aktif</span>
                            }
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <!-- Rol Değiştirme -->
                                <form asp-action="ToggleAdminRole" method="post" class="d-inline">
                                    <input type="hidden" name="userId" value="@user.Id" />
                                    <button type="submit" class="btn @(user.IsAdmin ? "btn-warning" : "btn-success")">
                                        @(user.IsAdmin ? "Adminliği Kaldır" : "Admin Yap")
                                    </button>
                                </form>

                                <!-- Şifre Sıfırlama -->
                                <button class="btn btn-info btn-reset-password" data-user-id="@user.Id"
                                        data-user-email="@user.Email">
                                    Şifre Sıfırla
                                </button>

                                <!-- Hesap Silme -->
                                <form asp-action="DeleteUser" method="post" class="d-inline"
                                      onsubmit="return confirm('Bu kullanıcıyı silmek istediğinize emin misiniz?');">
                                    <input type="hidden" name="userId" value="@user.Id" />
                                    <button type="submit" class="btn btn-danger">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>

                                <!-- Kilit Aç/Kapa -->
                                <form asp-action="ToggleUserLock" method="post" class="d-inline">
                                    <input type="hidden" name="userId" value="@user.Id" />
                                    <button type="submit" class="btn @(user.LockoutEnd?.UtcDateTime > DateTime.UtcNow ? "btn-success" : "btn-secondary")">
                                        @(user.LockoutEnd?.UtcDateTime > DateTime.UtcNow ? "Kilidi Aç" : "Kilitle")
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Şifre Sıfırlama Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Şifre Sıfırlama</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="resetPasswordForm" method="post">
                    <input type="hidden" name="userId" id="resetUserId" />
                    <div class="mb-3">
                        <label class="form-label">Yeni Şifre</label>
                        <input type="password" name="newPassword" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Şifre Tekrar</label>
                        <input type="password" name="confirmPassword" class="form-control" required />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="submit" form="resetPasswordForm" class="btn btn-primary">Kaydet</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Şifre hash kopyalama
        $(document).on('click', '.copy-hash', function() {
            navigator.clipboard.writeText($(this).data('hash'));
            toastr.success('Hash panoya kopyalandı');
        });

        // Şifre sıfırlama modal
        $(document).on('click', '.btn-reset-password', function() {
            const userId = $(this).data('user-id');
            const userEmail = $(this).data('user-email');
            $('#resetUserId').val(userId);
            $('#resetPasswordModal .modal-title').text(`${userEmail} şifresini sıfırla`);
            $('#resetPasswordModal').modal('show');
        });

        // Arama fonksiyonu
        $('#searchInput').keyup(function() {
            const searchText = $(this).val().toLowerCase();
            $('tbody tr').each(function() {
                const rowText = $(this).text().toLowerCase();
                $(this).toggle(rowText.includes(searchText));
            });
        });
    </script>
}